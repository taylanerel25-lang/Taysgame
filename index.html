<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tay’s Flapping Bird</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <style>
    :root {
      --sky:#87ceeb;
      --ground:#ded895;
      --pipe:#2fbf59;
      --panel:rgba(255,255,255,0.9);
      --shadow:rgba(0,0,0,0.25);
    }
    html,body{margin:0;height:100%;background:#111;font-family:system-ui,sans-serif;overflow:hidden}
    .wrap{position:fixed;inset:0;display:grid;place-items:center}
    canvas{background:var(--sky);border-radius:16px;box-shadow:0 10px 40px var(--shadow);touch-action:none}
    .hud{position:fixed;inset:0;pointer-events:none;display:grid;place-items:center;font-weight:700;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,0.5)}
    .score{position:fixed;top:18px;right:14px;font-size:28px}
    .splash{position:absolute;inset:0;display:grid;place-items:center;text-align:center}
    .splash .title{font-size:34px;margin-bottom:8px}
    .panel{min-width:260px;max-width:90vw;background:var(--panel);color:#111;border-radius:18px;padding:16px;box-shadow:0 8px 30px var(--shadow);pointer-events:auto}
    .panel h2{margin:0 0 8px 0;text-align:center}
    .panel .row{display:flex;justify-content:space-between;padding:4px 0}
    .panel .actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
    .btn{appearance:none;border:0;background:#fff;padding:8px 12px;border-radius:999px;font-weight:700;cursor:pointer}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);color:#fff;padding:8px 12px;border-radius:10px;font-size:14px;opacity:0;transition:opacity .25s,transform .25s}
    .toast.show{opacity:1;transform:translate(-50%,-6px)}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="360" height="640"></canvas>
  </div>

  <div class="hud">
    <div id="scoreHud" class="score">0</div>
    <div id="splash" class="splash">
      <div>
        <div class="title">Tay’s Flapping Bird</div>
        <div>Tap / Click / Space to start</div>
      </div>
    </div>
  </div>

  <div id="gameOver" class="hud" style="display:none;">
    <div class="panel">
      <h2>Game Over</h2>
      <div class="row"><span>Score</span><strong id="scoreNow">0</strong></div>
      <div class="row"><span>Best</span><strong id="bestNow">0</strong></div>
      <div class="actions">
        <button id="againBtn" class="btn">Play Again</button>
        <button id="shareBtn" class="btn">Share</button>
      </div>
      <!-- leaderboard will appear here -->
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <script>
  (() => {
    'use strict';
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const splash = document.getElementById('splash');
    const scoreHud = document.getElementById('scoreHud');
    const overPanel = document.getElementById('gameOver');
    const scoreNow = document.getElementById('scoreNow');
    const bestNow = document.getElementById('bestNow');
    const againBtn = document.getElementById('againBtn');
    const shareBtn = document.getElementById('shareBtn');
    const toast = document.getElementById('toast');

    const W = canvas.width;
    const H = canvas.height;
    const GROUND_H = 100;
    const PIPE_W = 64;
    const BASE_GAP = 160;
    let dynamicGap = window.dynamicPipeGap || BASE_GAP;

    let bird, pipes, score, best, state, lastTime, gravity, flapPower, gameSpeed;

    function reset() {
      bird = { x: 80, y: H / 2, vy: 0, r: 0 };
      pipes = [];
      score = 0;
      gravity = 900;
      flapPower = -300;
      gameSpeed = 180;
      state = 'ready';
      scoreHud.textContent = 0;
    }

    function startGame() {
      if (state === 'ready') {
        state = 'playing';
        splash.style.display = 'none';
        lastTime = performance.now();
        loop(lastTime);
      }
    }

    function gameOver() {
      state = 'over';
      scoreNow.textContent = score;
      best = Math.max(best, score);
      bestNow.textContent = best;
      localStorage.setItem('sb_best', best);
      overPanel.style.display = 'grid';
      if (window.showGameOver) window.showGameOver(score); // for Firebase hook
    }
    window.showGameOver = gameOver; // fallback for Firebase

    function spawnPipe() {
      const gap = window.dynamicPipeGap || dynamicGap;
      const center = Math.random() * (H - GROUND_H - gap - 100) + 50 + gap / 2;
      pipes.push({ x: W, y: center });
    }

    function update(dt) {
      if (state !== 'playing') return;

      // bird physics
      bird.vy += gravity * dt;
      bird.y += bird.vy * dt;
      bird.r = Math.min(Math.PI / 2, (bird.vy / 400));

      // spawn pipes
      if (!pipes.length || W - pipes[pipes.length - 1].x > 200) spawnPipe();

      // move pipes
      for (let p of pipes) p.x -= gameSpeed * dt;

      // remove old pipes
      if (pipes.length && pipes[0].x + PIPE_W < 0) pipes.shift();

      // collisions + scoring
      for (let p of pipes) {
        const gap = window.dynamicPipeGap || dynamicGap;
        const top = p.y - gap / 2;
        const bottom = p.y + gap / 2;
        if (
          bird.x + 17 > p.x && bird.x - 17 < p.x + PIPE_W &&
          (bird.y - 12 < top || bird.y + 12 > bottom)
        ) {
          gameOver();
        }
        if (!p.passed && p.x + PIPE_W < bird.x) {
          p.passed = true;
          score++;
          scoreHud.textContent = score;
        }
      }

      // hit ground or ceiling
      if (bird.y > H - GROUND_H - 12 || bird.y < 0) {
        gameOver();
      }
    }

    function draw() {
      ctx.fillStyle = '#87ceeb';
      ctx.fillRect(0, 0, W, H);

      // pipes
      ctx.fillStyle = '#2fbf59';
      for (let p of pipes) {
        const gap = window.dynamicPipeGap || dynamicGap;
        const topH = p.y - gap / 2;
        const bottomY = p.y + gap / 2;
        ctx.fillRect(p.x, 0, PIPE_W, topH);
        ctx.fillRect(p.x, bottomY, PIPE_W, H - bottomY - GROUND_H);
      }

      // ground
      ctx.fillStyle = '#ded895';
      ctx.fillRect(0, H - GROUND_H, W, GROUND_H);

      // bird
      ctx.save();
      ctx.translate(bird.x, bird.y);
      ctx.rotate(bird.r);
      ctx.fillStyle = '#ffcc00';
      ctx.beginPath();
      ctx.ellipse(0, 0, 17, 12, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }

    function loop(now) {
      const dt = (now - lastTime) / 1000;
      lastTime = now;
      update(dt);
      draw();
      if (state !== 'over') requestAnimationFrame(loop);
    }

    // --- Input handling ---
    function flap() {
      if (state === 'over') return;
      if (state === 'ready') startGame();
      bird.vy = flapPower;
    }

    canvas.addEventListener('mousedown', flap);
    canvas.addEventListener('touchstart', e => { e.preventDefault(); flap(); });
    window.addEventListener('keydown', e => {
      if ([' ', 'ArrowUp', 'w'].includes(e.key)) { e.preventDefault(); flap(); }
    });

    againBtn.addEventListener('click', () => {
      overPanel.style.display = 'none';
      splash.style.display = 'grid';
      reset();
    });

    shareBtn.addEventListener('click', async () => {
      const msg = `I scored ${score} in Tay’s Flapping Bird! Can you beat me?`;
      try {
        if (navigator.share) await navigator.share({ text: msg, title: "Tay’s Flapping Bird" });
        else { await navigator.clipboard.writeText(msg); showToast('Copied!'); }
      } catch { }
    });

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove('show'), 1500);
    }
    window.showToast = showToast;

    // --- Init ---
    best = Number(localStorage.getItem('sb_best') || 0);
    reset();
    draw();
  })();
  </script>
  <!-- === Firebase + Leaderboard + Adaptive Difficulty + Anti-Spam === -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, push, query, orderByChild, limitToLast, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import { getRemoteConfig, fetchAndActivate, getValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-remote-config.js";

    /* === Your Firebase project config === */
    const firebaseConfig = {
      apiKey: "HIDDEN_FOR_SECURITY",
      authDomain: "tay-s-game.firebaseapp.com",
      projectId: "tay-s-game",
      storageBucket: "tay-s-game.firebasestorage.app",
      messagingSenderId: "562563277539",
      appId: "1:562563277539:web:83f23217bde8543d19dbd6",
      measurementId: "G-LHR4F18RTJ",
      databaseURL: "https://tay-s-game-default-rtdb.firebaseio.com"
    };

    /* === Initialize Firebase === */
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const analytics = getAnalytics(app);
    const remoteConfig = getRemoteConfig(app);
    remoteConfig.settings.minimumFetchIntervalMillis = 60000;
    remoteConfig.defaultConfig = { current_pipe_gap_size: 160 };

    /* === Adaptive difficulty === */
    async function loadAdaptiveDifficulty() {
      try {
        await fetchAndActivate(remoteConfig);
        const gap = Number(getValue(remoteConfig, "current_pipe_gap_size")._value);
        window.dynamicPipeGap = gap;
        console.log("✅ Pipe gap loaded from Remote Config:", gap);
      } catch (err) {
        console.warn("⚠️ Remote Config failed – using default 160 px", err);
        window.dynamicPipeGap = 160;
      }
    }
    loadAdaptiveDifficulty();

    /* === Leaderboard display === */
    async function updateLeaderboardDisplay() {
      const lbRef = query(ref(db, "leaderboard"), orderByChild("score"), limitToLast(10));
      const snap = await get(lbRef);
      if (!snap.exists()) return;
      const entries = Object.values(snap.val()).sort((a,b)=>b.score-a.score);
      const panel = document.querySelector("#gameOver .panel");
      let list = document.getElementById("leaderboardList");
      if (!list) {
        list = document.createElement("div");
        list.id = "leaderboardList";
        list.style.marginTop = "12px";
        list.style.fontSize = "16px";
        list.innerHTML = "<h3 style='text-align:center;'>🏆 Leaderboard</h3>";
        panel.appendChild(list);
      }
      list.innerHTML = "<h3 style='text-align:center;'>🏆 Leaderboard</h3>" +
        entries.map((e,i)=>`<div class='row'><span>${i+1}. ${e.name||"Anonymous"}</span><strong>${e.score}</strong></div>`).join("");
    }

    /* === Score submission + anti-spam === */
    async function submitScore(name, score) {
      const lbRef = ref(db, "leaderboard");
      await push(lbRef, { name: name || "Anonymous", score, date: Date.now() });
      await updateLeaderboardDisplay();
    }

    let lastSubmitTime = 0;
    async function safeSubmitScore(name, score) {
      const now = Date.now();
      if (now - lastSubmitTime < 30000) {
        const toast = document.getElementById("toast");
        toast.textContent = "Please wait before submitting again";
        toast.classList.add("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=>toast.classList.remove("show"),1500);
        return;
      }
      lastSubmitTime = now;
      await submitScore(name, score);
    }

    /* === Hook into gameOver === */
    const originalGameOver = window.showGameOver;
    window.showGameOver = async function(scoreVal = 0) {
      if (originalGameOver && originalGameOver !== window.showGameOver) originalGameOver();
      logEvent(analytics, "game_over", { score: scoreVal });
      let playerName = localStorage.getItem("player_name") || "";
      if (!playerName || scoreVal >= (Number(localStorage.getItem("sb_best")||0))) {
        playerName = prompt("New high score! Enter your name for the leaderboard:") || "Anonymous";
        localStorage.setItem("player_name", playerName);
      }
      await safeSubmitScore(playerName, scoreVal);
      updateLeaderboardDisplay();
    };
  </script>
</body>
</html>
