<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Swimming Fish</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#20b2aa" />
  <style>
    :root {
      --bg: #20b2aa;
      --panel: rgba(255,255,255,.9);
      --panel-dark: rgba(0,0,0,.65);
      --text: #1d1d1f;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: #111;
      color: var(--text);
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans";
      overscroll-behavior: none;
    }
    .wrap {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    canvas {
      background: var(--bg);
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
      border-radius: 16px;
      image-rendering: pixelated;
      touch-action: none;
    }
    .hud {
      position: fixed;
      inset: 0;
      pointer-events: auto; /* PATCH: allow clicks/taps */
      display: grid;
      place-items: center;
      font-weight: 700;
      letter-spacing: .5px;
      user-select: none;
    }
    .splash {
      position: absolute;
      inset: 0;
      color: #000;
      text-shadow: 0 2px 0 rgba(255,255,255,.5);
    }
    .btn {
      appearance: none;
      border: 0;
      background: var(--panel);
      color: #111;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      cursor: pointer;
      line-height: 1;
    }
    .btn:focus {
      outline: 3px solid #000;
      outline-offset: 2px;
    }
    .score {
      position: fixed;
      top: 18px;
      right: 14px;
      font-size: 28px;
      color: #fff;
      text-shadow: 0 2px 0 rgba(0,0,0,.6);
      pointer-events: none;
    }
    .best {
      position: fixed;
      top: 18px;
      left: 14px;
      font-size: 16px;
      color: #fff;
      text-shadow: 0 2px 0 rgba(0,0,0,.6);
      pointer-events: none;
    }
    .splash-inner {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 10%;
      width: min(92%, 360px);
      text-align: center;
      pointer-events: none;
    }
    .title { font-size: 36px; margin: 2px 0 8px; }
    .subtitle { font-size: 18px; opacity: .95; }
    .splash-board {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      width: min(92%, 360px);
      background: rgba(0,0,0,.65);
      color: #f0f0f0;
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,.25);
      pointer-events: auto;
    }
    .board-head { font-size: 20px; font-weight: 800; text-align: center; margin: 0 0 6px; }
    .board-row {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 16px; padding: 6px 0;
    }
    .panel {
      min-width: 280px;
      max-width: 90vw;
      background: var(--panel);
      color: #111;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,.25);
      pointer-events: auto;
      transform: translateY(8px);
    }
    .panel h2 { margin: 0 0 8px 0; font-size: 22px; text-align: center; }
    .panel .row { display: flex; justify-content: space-between; align-items: center; font-size: 18px; padding: 6px 0; }
    .panel .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(0,0,0,.08); padding: 4px 10px; border-radius: 999px; font-size: 14px;
    }
    .sr-only {
      position: absolute !important; width: 1px; height: 1px; padding: 0;
      margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }
    .toast {
      position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,.85); color: #fff; padding: 8px 12px; border-radius: 10px;
      font-size: 14px; pointer-events: none; opacity: 0;
      transition: opacity .25s ease, transform .25s ease;
    }
    .toast.show { opacity: 1; transform: translate(-50%, -6px); }
    .soundbar { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); pointer-events: auto; display: flex; gap: 8px; }
    .name-modal {
      position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.35);
    }
    .name-card {
      width: min(92%, 360px); background: #fff; color: #111;
      border-radius: 18px; padding: 16px; box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    .name-card h3 { margin: 0 0 8px 0; text-align: center; }
    .name-row { display: flex; gap: 8px; margin-top: 10px; }
    .name-row input {
      flex: 1; border-radius: 12px; border: 2px solid #ddd;
      padding: 10px 12px; font-size: 16px;
    }
    .name-row button { white-space: nowrap; }
    .tutorial {
      position: fixed; inset: 0; display: none; place-items: center;
      background: rgba(0,0,0,.5); pointer-events: auto;
    }
    .tutorial-card {
      width: min(92%, 360px); background: #fff; color: #111;
      border-radius: 18px; padding: 16px; text-align: center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <canvas id="game" width="360" height="640" aria-label="Swimming Fish canvas"></canvas>
  </div>

  <div class="hud" aria-hidden="true">
    <div class="soundbar">
      <button id="muteBtn" class="btn" aria-pressed="false">üîä Sound</button>
      <button id="pauseBtn" class="btn">‚è∏ Pause</button>
      <button id="musicBtn" class="btn" aria-pressed="true">üéµ Music</button>
    </div>
    <div id="scoreHud" class="score">0</div>
    <div id="bestHud" class="best">Highest: 0</div>
    <div id="splash" class="splash">
      <div class="splash-inner">
        <div class="title">Swimming Fish</div>
        <div style="font-size:14px;opacity:.9">Made for xAI by Taylan‚Ñ¢</div>
        <div class="subtitle">Tap / Click / Space to start</div>
        <div style="margin-top:6px;font-size:14px;opacity:.9">
          Avoid obstacles, collect shells &amp; starfish. Good luck!
        </div>
      </div>
      <div id="splashBoard" class="splash-board">
        <div class="board-head">üèÜ Leaderboard</div>
        <div id="leaderboardSplashBody" style="font-size:16px;text-align:center;">Loading...</div>
      </div>
    </div>
  </div>
  <!-- Game over panel -->
  <div id="gameOver" class="hud" style="display:none;">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="overTitle">
      <h2 id="overTitle">Game Over</h2>
      <div class="row"><span>Your Score</span><strong id="scoreNow">0</strong></div>
      <div class="row">
        <span>Highest Score</span>
        <span><strong id="bestNow">0</strong>
          <span id="medal" class="pill" style="display:none;">ü•â Bronze</span>
        </span>
      </div>
      <div class="actions">
        <button id="againBtn" class="btn">Play Again</button>
        <button id="shareBtn" class="btn">Share</button>
      </div>
      <div id="leaderboardOver" class="panel dark" style="margin-top:12px;padding:12px;">
        <div style="text-align:center;font-weight:800;">üèÜ Leaderboard</div>
        <div id="leaderboardOverBody" style="margin-top:6px;font-size:16px;">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Name input modal -->
  <div id="nameModal" class="name-modal" role="dialog" aria-modal="true" aria-labelledby="nameTitle">
    <div class="name-card">
      <h3 id="nameTitle">Welcome! Enter your name</h3>
      <p style="margin:0 0 6px;text-align:center;opacity:.8;font-size:14px;">
        It‚Äôll appear on the leaderboard across all devices.
      </p>
      <div class="name-row">
        <input id="playerNameInput" type="text" placeholder="e.g. Tay" maxlength="24" />
        <button id="saveNameBtn" class="btn">Save</button>
      </div>
    </div>
  </div>

  <!-- Tutorial modal -->
  <div id="tutorialModal" class="tutorial">
    <div class="tutorial-card">
      <h3>Welcome to Swimming Fish!</h3>
      <p>Tap, click, or press Space to swim up. Hold for a stronger boost!</p>
      <p>Avoid corals, sharks, and jellyfish. Collect shells and rare xAI starfish for points!</p>
      <button id="tutorialCloseBtn" class="btn">Got it!</button>
    </div>
  </div>

  <div id="aria" class="sr-only" aria-live="polite"></div>
  <div id="toast" class="toast" role="status"></div>

  <script>
(() => {
'use strict';

/* ========= ASSET LOADING ========= */
const sharkImg = new Image();
sharkImg.src = "https://i.imgur.com/8zX9k7L.png";
const playerFishImg = new Image();
playerFishImg.src = "https://i.imgur.com/3k2vXjP.png";
const bgFishImg = new Image();
bgFishImg.src = "https://i.imgur.com/9m4tQ8Z.png";
const bgMusic = new Audio('/assets/ocean-ambience.mp3');
bgMusic.loop = true;

// Preload SFX (new)
const sfx_flap   = new Audio('/assets/flap.wav');
const sfx_point  = new Audio('/assets/point.wav');
const sfx_hit    = new Audio('/assets/hit.wav');
const sfx_die    = new Audio('/assets/die.wav');
const sfx_swoosh = new Audio('/assets/swoosh.wav');
const sfx_collect= new Audio('/assets/collect.wav');

/* ========= CONFIGURATION ========= */
const CFG = {
  canvas: { width: 360, height: 640 },
  physics: {
    gravity: 1200,
    flapImpulse: -360,
    boostMax: -540,
    boostChargeTime: 0.5,
    boostCooldown: 1,
    maxFallSpeed: 720
  },
  world: {
    speedStart: 180,
    speedEnd: 240,
    speedEndScore: 30
  },
  pipes: {
    gapStart: 160,
    gapEnd: 135,
    gapEndScore: 20,
    spawnStart: 1.2,
    spawnEnd: 0.95,
    spawnEndScore: 25,
    minGapCenterY: 120,
    maxGapCenterYPaddingBottom: 120,
    width: 64
  },
  bird: { size: { w: 40, h: 24 }, hitboxRadius: 12 },
  ground: { height: 112 },
  scorePopup: { dy: 40, duration: 0.6 },
  birdIdleBobPx: 4,
  particles: { max: 50, flapCount: 8, collectCount: 10 },
  collectibles: { chance: 0.4, bonus: 5, xaiBonus: 10, size: 16 }
};
const DPR = Math.min(window.devicePixelRatio || 1, 3);

/* ========= DOM REFERENCES ========= */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
if (!ctx) { console.error('Canvas context not found.'); return; }

const splashEl = document.getElementById('splash');
const hudScore = document.getElementById('scoreHud');
const overPanel = document.getElementById('gameOver');
const scoreNow = document.getElementById('scoreNow');
const bestNow = document.getElementById('bestNow');
const medalEl = document.getElementById('medal');
const muteBtn = document.getElementById('muteBtn');
const pauseBtn = document.getElementById('pauseBtn');
const musicBtn = document.getElementById('musicBtn');
const ariaLive = document.getElementById('aria');
const toast = document.getElementById('toast');
const nameModal = document.getElementById('nameModal');
const nameInput = document.getElementById('playerNameInput');
const saveNameBtn = document.getElementById('saveNameBtn');
const tutorialModal = document.getElementById('tutorialModal');
const tutorialCloseBtn = document.getElementById('tutorialCloseBtn');

/* ========= STATE ========= */
const W = CFG.canvas.width, H = CFG.canvas.height;
const groundY = H - CFG.ground.height;
let state = 'ready';
let paused = false;
let worldTime = 0;
let spawnTimer = 0;
let lastMs = performance.now();
let flapHoldTime = 0;
let boostCooldown = 0;
let musicPlaying = (localStorage.getItem('sb_music') ?? '1') === '1';
let pipeStreak = 0;
let flapsSinceLastPipe = 0;

const storage = {
  best: Number(localStorage.getItem('sb_best') || 0),
  muted: localStorage.getItem('sb_muted') === '1',
  seenTutorial: localStorage.getItem('sb_seenTutorial') === '1'
};

if (storage.muted) {
  muteBtn.setAttribute('aria-pressed','true');
  muteBtn.textContent = 'üîá Muted';
}
if (!musicPlaying) {
  musicBtn.setAttribute('aria-pressed','false');
  musicBtn.textContent = 'üé∂ Music Off';
}

const BIRD_X = Math.round(W * 0.28);
let bird = { x: BIRD_X, y: H * 0.5, vy: 0, rot: 0, frame: 0, frameTimer: 0 };
const pipes = [];
const pops = [];
const bubblesBg = [{x:100,y:80,s:0.15},{x:300,y:120,s:0.12},{x:200,y:50,s:0.18}];
const bubblesFg = [{x:40,y:100,s:0.3},{x:240,y:60,s:0.25},{x:170,y:140,s:0.22}];
let score = 0;
let collectibles = [];
const particles = [];
/* ========= AUDIO ========= */
let audioCtx = null;
const playSound = (audioEl) => {
  if (!audioCtx || storage.muted) return;
  try {
    audioEl.currentTime = 0;
    audioEl.play().catch(()=>{});
  } catch (e) { console.warn('Audio play failed:', e); }
};
const sfx = {
  flap:   () => playSound(sfx_flap),
  point:  () => playSound(sfx_point),
  hit:    () => playSound(sfx_hit),
  die:    () => playSound(sfx_die),
  swoosh: () => playSound(sfx_swoosh),
  collect:() => playSound(sfx_collect)
};

/* ========= HELPERS ========= */
const clamp = (v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const lerp = (a,b,t)=>a+(b-a)*t;
const easeT=(s,end)=>clamp(s/end,0,1);
const pipeGap=()=>lerp(CFG.pipes.gapStart,CFG.pipes.gapEnd,easeT(score,CFG.pipes.gapEndScore));
const spawnInterval=()=>lerp(CFG.pipes.spawnStart,CFG.pipes.spawnEnd,easeT(score,CFG.pipes.spawnEndScore));
const speedBase=()=>lerp(CFG.world.speedStart,CFG.world.speedEnd,easeT(score,CFG.world.speedEndScore));
const showToast=(m)=>{toast.textContent=m;toast.classList.add('show');clearTimeout(showToast._t);
  showToast._t=setTimeout(()=>toast.classList.remove('show'),1200);};
const announce=(m)=>{ariaLive.textContent='';setTimeout(()=>ariaLive.textContent=m,30);};

function resetGame(){
  score=0;hudScore.textContent='0';window.score=0;
  worldTime=0;spawnTimer=-0.5;pipes.length=0;pops.length=0;collectibles.length=0;particles.length=0;
  bird={x:BIRD_X,y:H*0.5,vy:0,rot:0,frame:0,frameTimer:0};
  sfx.swoosh();pipeStreak=0;flapsSinceLastPipe=0;
  document.getElementById('bestHud').textContent=`Highest: ${storage.best}`;
}

/* ========= RESIZE ========= */
function fitCanvas(){
  const aspect=W/H,vw=innerWidth,vh=innerHeight;let cssW,cssH;
  if(vw/vh<aspect){cssW=Math.min(vw,W*2.5);cssH=Math.round(cssW/aspect);}
  else{cssH=Math.min(vh,H*2.5);cssW=Math.round(cssH*aspect);}
  canvas.style.width=cssW+'px';canvas.style.height=cssH+'px';
  canvas.width=W*DPR;canvas.height=H*DPR;
  ctx.setTransform(1,0,0,1,0,0);ctx.scale(DPR,DPR);ctx.imageSmoothingEnabled=false;
}
addEventListener('resize',fitCanvas,{passive:true});fitCanvas();

/* ========= INPUT ========= */
let isHolding=false;
const flap=()=>{
  if(state==='dead'||boostCooldown>0)return;
  if(!audioCtx){try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();audioCtx.resume().catch(()=>{});}catch{}}
  if(!localStorage.getItem('player_name')){openNameModal();return;}
  if(state==='ready'){state='running';announce('Game started');splashEl.style.display='none';
    if(!storage.seenTutorial){tutorialModal.style.display='grid';paused=true;}}
  const impulse=lerp(CFG.physics.flapImpulse,CFG.physics.boostMax,clamp(flapHoldTime/CFG.physics.boostChargeTime,0,1));
  bird.vy=impulse;sfx.flap();boostCooldown=CFG.physics.boostCooldown;flapsSinceLastPipe++;
flapHoldTime = 0; // reset charge after use
  for(let i=0;i<CFG.particles.flapCount;i++){
    particles.push({x:bird.x+Math.random()*10,y:bird.y+Math.random()*CFG.bird.size.h-CFG.bird.size.h/2,
      vx:-speedBase()*0.3+Math.random()*30-15,vy:Math.random()*-50-20,life:1+Math.random()*0.8,
      size:2+Math.random()*4,color:'rgba(255,255,255,0.8)',t:0});}
};

canvas.addEventListener('mousedown', e => { e.preventDefault(); isHolding = true; });
canvas.addEventListener('mouseup', () => { if (!isHolding) return; isHolding = false; flap(); });

canvas.addEventListener('touchstart', e => { e.preventDefault(); isHolding = true; }, { passive: false });
canvas.addEventListener('touchend',  () => { if (!isHolding) return; isHolding = false; flap(); });

addEventListener('keydown', e => {
  const k = e.key.toLowerCase(); const flapKeys = [' ','space','spacebar','w','arrowup'];
  if (flapKeys.includes(k)) { e.preventDefault(); isHolding = true; } // no flap here
  if (k === 'p' && state === 'running') { paused = !paused; showToast(paused ? 'Paused' : 'Resumed'); }
});
addEventListener('keyup', e => {
  const k = e.key.toLowerCase(); const flapKeys = [' ','space','spacebar','w','arrowup'];
  if (flapKeys.includes(k)) { if (!isHolding) return; isHolding = false; flap(); }
});

/* ========= UI ========= */
muteBtn.onclick=()=>{
  storage.muted=!storage.muted;
  localStorage.setItem('sb_muted',storage.muted?'1':'0');
  muteBtn.setAttribute('aria-pressed',storage.muted?'true':'false');
  muteBtn.textContent=storage.muted?'üîá Muted':'üîä Sound';
  if(storage.muted)bgMusic.pause();else if(musicPlaying)bgMusic.play().catch(()=>{});
};
pauseBtn.onclick=()=>{if(state==='running'){paused=!paused;showToast(paused?'Paused':'Go!');}};
musicBtn.onclick=()=>{
  musicPlaying=!musicPlaying;
  localStorage.setItem('sb_music',musicPlaying?'1':'0');
  musicBtn.setAttribute('aria-pressed',musicPlaying?'true':'false');
  musicBtn.textContent=musicPlaying?'üéµ Music':'üé∂ Music Off';
  if(musicPlaying&&!storage.muted)bgMusic.play().catch(()=>{});else bgMusic.pause();
};
document.getElementById('againBtn').onclick=()=>{
  overPanel.style.display='none';splashEl.style.display='';state='ready';resetGame();announce('Back to splash');
};
document.getElementById('shareBtn').onclick=async()=>{
  const text=`I scored ${scoreNow.textContent} in Swimming Fish! Can you beat me?`;
  try{if(navigator.share)await navigator.share({text,title:"Swimming Fish"});
  else{await navigator.clipboard.writeText(text);showToast('Copied to clipboard!');}}catch{}
};
tutorialCloseBtn.onclick=()=>{
  tutorialModal.style.display='none';paused=false;state='running';
  localStorage.setItem('sb_seenTutorial','1');storage.seenTutorial=true;announce('Tutorial closed');
};

/* ========= NAME MODAL ========= */
function openNameModal(){
  nameModal.style.display='grid';
  nameInput.value=localStorage.getItem('player_name')||'';
  setTimeout(()=>nameInput.focus(),10);
}
function saveName(){
  const raw=(nameInput.value||'').trim();
  const clean=raw.replace(/[.#$/]/g,'').slice(0,24);
  if(!clean){showToast('Please enter a name');nameInput.focus();return;}
  localStorage.setItem('player_name',clean);nameModal.style.display='none';showToast(`Hi, ${clean}!`);
}
saveNameBtn.onclick=saveName;
nameInput.addEventListener('keydown',e=>{if(e.key==='Enter')saveName();});

/* ========= GAME LOGIC ========= */
function spawnPipe(){
  const gap=pipeGap();
  const pad=CFG.pipes.maxGapCenterYPaddingBottom;
  const minC=CFG.pipes.minGapCenterY;
  const maxCenter=(groundY-pad)-gap/2;
  const minCenter=minC+gap/2;
  const gapY=Math.round(lerp(minCenter,maxCenter,Math.random()));
  const type=Math.random()<0.1?'jellyfish':Math.random()<0.3?'shark':'coral';
  pipes.push({x:W+10,gapY,gap,w:CFG.pipes.width,scored:false,type,phase:Math.random()*Math.PI*2});
  if(Math.random()<CFG.collectibles.chance){
    const collY=gapY+(Math.random()-0.5)*(gap-CFG.collectibles.size*2);
    const isXAI=Math.random()<0.01;
    collectibles.push({x:W+10+CFG.pipes.width/2,y:collY,collected:false,type:isXAI?'xai':'shell'});
  }
}

function circleRectDeepOverlap(c,r,need){
  const nx=clamp(c.x,r.x,r.x+r.w),ny=clamp(c.y,r.y,r.y+r.h);
  const dist=Math.hypot(c.x-nx,c.y-ny);
  return (c.r-dist)>need;
}

function die(){
  state='dead';paused=false;if(navigator.vibrate)navigator.vibrate(80);
  sfx.die();
  for(let i=0;i<15;i++){particles.push({x:bird.x,y:bird.y,vx:Math.random()*200-100,vy:Math.random()*200-100,life:0.5,size:5,color:'rgba(255,0,0,0.8)',t:0});}
  const fall=()=>{const now=performance.now();const dt=Math.min((now-lastMs)/1000,1/30);
    lastMs=now;bird.vy+=CFG.physics.gravity*dt;bird.vy=Math.min(bird.vy,CFG.physics.maxFallSpeed);
    bird.y+=bird.vy*dt;bird.rot=lerp(bird.rot,90*Math.PI/180,0.12);render();
    if(bird.y+CFG.bird.hitboxRadius<groundY)requestAnimationFrame(fall);
    else{bird.y=groundY-CFG.bird.hitboxRadius;setTimeout(showGameOver,800);}
  };fall();
}  
function showGameOver(){
  scoreNow.textContent=String(score);
  if(score>storage.best){storage.best=score;localStorage.setItem('sb_best',String(score));}
  bestNow.textContent=String(storage.best);
  document.getElementById('bestHud').textContent=`Highest: ${storage.best}`;
  const medals=s=>s>=50?['üèÜ Platinum','#e5e4e2']:s>=30?['ü•á Gold','#f7c32e']:s>=20?['ü•à Silver','#c0c0c0']:s>=10?['ü•â Bronze','#cd7f32']:null;
  const m=medals(storage.best);
  if(m){medalEl.style.display='';medalEl.textContent=m[0];}else medalEl.style.display='none';
  overPanel.style.display='';
}

/* ========= UPDATE ========= */
function update(dt){
  if(state!=='running'||paused)return;
  const speed=speedBase();worldTime+=dt;spawnTimer+=dt;
  if(spawnTimer>=spawnInterval()){spawnTimer=0;spawnPipe();}
  for(const b of bubblesFg){b.x-=speed*b.s*dt;if(b.x<-80)b.x+=W+160;}
  for(const b of bubblesBg){b.x-=speed*b.s*dt;if(b.x<-80)b.x+=W+160;}
  bird.vy+=CFG.physics.gravity*dt;bird.vy=clamp(bird.vy,-9999,CFG.physics.maxFallSpeed);
  bird.y+=bird.vy*dt;bird.y=clamp(bird.y,2,H+1000);
  bird.rot=lerp(bird.rot,bird.vy<0?-15*Math.PI/180:60*Math.PI/180,0.12);
  if(isHolding)flapHoldTime+=dt;if(boostCooldown>0)boostCooldown-=dt;

  for(const p of pipes){
    p.x-=speed*dt;
    if(p.type==='jellyfish')p.gapY+=Math.sin(p.phase+worldTime*2)*30*dt;
    const cx=p.x+p.w/2;
    if(!p.scored&&cx<bird.x){
      p.scored=true;score++;hudScore.textContent=score;window.score=score;
      if(score>storage.best){storage.best=score;localStorage.setItem('sb_best',String(score));document.getElementById('bestHud').textContent=`Highest: ${storage.best}`;}
      pops.push({x:cx,y:p.gapY,t:0,duration:CFG.scorePopup.duration,text:'+1'});
      sfx.point();announce(`Score ${score}`);
    }
  }
  pipes = pipes.filter(p=>p.x+p.w>-20);
  const r=CFG.bird.hitboxRadius,circle={x:bird.x+2,y:bird.y,r};
  for(const p of pipes){
    if(p.type==='shark'){
      const rect={x:p.x,y:p.gapY-32,w:p.w*1.2,h:p.w*0.6};
      if(circleRectDeepOverlap(circle,rect,0.1*r))return die();
    }else{
      const top={x:p.x,y:-9999,w:p.w,h:(p.gapY-p.gap/2)+9999};
      const bot={x:p.x,y:(p.gapY+p.gap/2),w:p.w,h:(groundY-(p.gapY+p.gap/2))};
      if(circleRectDeepOverlap(circle,top,0.1*r)||circleRectDeepOverlap(circle,bot,0.1*r))return die();
    }
  }
  if(circle.y+circle.r>=groundY)return die();
}

/* ========= RENDERING ========= */
function drawBubbles(list,op){for(const b of list){ctx.save();ctx.translate(b.x,b.y);
  const g=ctx.createRadialGradient(0,0,0,0,0,20);
  g.addColorStop(0,`rgba(255,255,255,${op})`);g.addColorStop(1,`rgba(255,255,255,${op*0.2})`);
  ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,20,0,Math.PI*2);ctx.fill();ctx.restore();}}

function drawFish(){
  ctx.save();const w=CFG.bird.size.w,h=CFG.bird.size.h;
  ctx.translate(bird.x,bird.y);ctx.rotate(bird.rot);ctx.scale(-1,1);
  if(playerFishImg.complete)ctx.drawImage(playerFishImg,-w/2,-h/2,w,h);
  else{ctx.fillStyle='#87cefa';ctx.fillRect(-w/2,-h/2,w,h);}
  ctx.restore();
}

function drawPipes(){
  for (const p of pipes) {
    const topH = p.gapY - p.gap / 2;
    const botY = p.gapY + p.gap / 2;

    if (p.type === 'shark') {
      if (sharkImg.complete && sharkImg.naturalWidth) {
        const sharkW = Math.max(64, sharkImg.width * 0.6);
        const sharkH = sharkW * 0.5;
        ctx.drawImage(sharkImg, p.x + (p.w - sharkW) / 2, p.gapY - sharkH / 2, sharkW, sharkH);
      } else {
        ctx.fillStyle = '#808080';
        ctx.fillRect(p.x, p.gapY - 18, p.w, 36);
      }
    } else if (p.type === 'jellyfish') {
      ctx.fillStyle = '#ff69b4';
      ctx.fillRect(p.x, 0, p.w, topH);
      ctx.fillRect(p.x, botY, p.w, groundY - botY);
    } else {
      ctx.fillStyle = '#ff6347';
      ctx.fillRect(p.x, 0, p.w, topH);
      ctx.fillRect(p.x, botY, p.w, groundY - botY);
    }
  }
}

function drawGround(){
  ctx.fillStyle='#f4a460';
  ctx.fillRect(0,groundY,W,H-groundY);
}

function drawParticles(){
  ctx.save();
  for(const p of particles){
    p.t+=0.016;p.x+=p.vx*0.016;p.y+=p.vy*0.016;
    ctx.globalAlpha=1-p.t/p.life;
    ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();
  }
  ctx.restore();
}

function drawHUD(){
  for(const pop of pops){
    const t=clamp(pop.t/pop.duration,0,1);
    const y=pop.y-t*CFG.scorePopup.dy;
    ctx.globalAlpha=1-t;ctx.fillStyle='#fff';ctx.font='bold 20px ui-rounded,system-ui,sans-serif';
    ctx.textAlign='center';ctx.fillText(pop.text,pop.x,y);
    ctx.globalAlpha=1;
  }
}

function render(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#20b2aa';ctx.fillRect(0,0,W,H);
  drawBubbles(bubblesBg,0.3);
  drawPipes();
  drawFish();
  drawBubbles(bubblesFg,0.6);
  drawParticles();
  drawGround();
  drawHUD();
  if (bgFishImg.complete && bgFishImg.naturalWidth) {
    ctx.globalAlpha = 0.25;
    const swimX = (worldTime * 60) % (W + 60) - 60;
    ctx.drawImage(bgFishImg, swimX, H * 0.4, 24, 12);
    ctx.globalAlpha = 1;
  }
}

/* ========= MAIN LOOP ========= */
function loop(now){
  const dt=clamp((now-lastMs)/1000,0,1/30);
  lastMs=now;
  if(state==='ready')worldTime+=dt;
  else if(state==='running'&&!paused){worldTime+=dt;update(dt);}
  render();
  requestAnimationFrame(loop);
}

/* ========= INIT ========= */
function init(){
  resetGame();
  splashEl.style.display='';
  hudScore.textContent='0';
  document.getElementById('bestHud').textContent=`Highest: ${storage.best}`;
  bestNow.textContent=String(storage.best);
  overPanel.style.display='none';
  lastMs=performance.now();
  requestAnimationFrame(loop);
  if(!localStorage.getItem('player_name')) {
    openNameModal();
    localStorage.setItem('player_name', 'Guest'); // allow play immediately
  }
  if(!storage.muted&&musicPlaying)bgMusic.play().catch(()=>{});
}
window.addEventListener('load',()=>{
  Promise.all([
    new Promise(r=>{sharkImg.onload=r;sharkImg.onerror=r;}),
    new Promise(r=>{playerFishImg.onload=r;playerFishImg.onerror=r;}),
    new Promise(r=>{bgFishImg.onload=r;bgFishImg.onerror=r;})
  ]).then(init);
});
})();
  </script>
</body>
</html>
