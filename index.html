package com.taygames.flipperfish;  // keep exactly this

import android.annotation.SuppressLint;
import android.content.res.Configuration;
import android.os.Bundle;
import android.util.Log;
import android.view.Gravity;
import android.view.View;
import android.webkit.JavascriptInterface;
import android.webkit.WebView;
import android.widget.FrameLayout;

import androidx.annotation.NonNull;

import com.getcapacitor.BridgeActivity;

import com.google.android.gms.ads.AdError;
import com.google.android.gms.ads.AdListener;
import com.google.android.gms.ads.AdRequest;
import com.google.android.gms.ads.AdSize;
import com.google.android.gms.ads.MobileAds;
import com.google.android.gms.ads.LoadAdError;
import com.google.android.gms.ads.AdView;
import com.google.android.gms.ads.FullScreenContentCallback;
import com.google.android.gms.ads.rewarded.RewardedAd;
import com.google.android.gms.ads.rewarded.RewardedAdLoadCallback;

public class MainActivity extends BridgeActivity {

    private WebView webView;       // Capacitor WebView
    private AdView bannerView;     // Banner ad (native, overlaid)
    private RewardedAd rewardedAd; // Rewarded cache
    private boolean pendingReward = false; // set true when user earns reward

    // Google TEST unit IDs (official test IDs)
    private static final String TEST_BANNER_ID   = "ca-app-pub-3940256099942544/6300978111";  // Banner test
    private static final String TEST_REWARDED_ID = "ca-app-pub-3940256099942544/5224354917";  // Rewarded test

    @SuppressLint("SetJavaScriptEnabled")
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        MobileAds.initialize(this, status -> {});

        webView = this.bridge.getWebView();
        if (webView != null) {
            webView.addJavascriptInterface(new AdsBridge(), "AdsBridge");
        } else {
            Log.e("MainActivity", "WebView is null; bridge not registered");
        }

        // Banner setup (fixed AdSize.BANNER to avoid crashes)
        bannerView = new AdView(this);
        bannerView.setAdUnitId(TEST_BANNER_ID);
        bannerView.setAdSize(AdSize.BANNER);
        bannerView.setVisibility(View.GONE);

        FrameLayout.LayoutParams bannerLp = new FrameLayout.LayoutParams(
                FrameLayout.LayoutParams.WRAP_CONTENT,
                FrameLayout.LayoutParams.WRAP_CONTENT
        );
        bannerLp.gravity = Gravity.TOP | Gravity.START; // we will set margins dynamically
        addContentView(bannerView, bannerLp);

        // Preload banner
        AdRequest adRequest = new AdRequest.Builder().build();
        bannerView.loadAd(adRequest);
        bannerView.setAdListener(new AdListener() {
            @Override
            public void onAdFailedToLoad(@NonNull LoadAdError error) {
                Log.e("AdsBridge", "Banner failed to load: " + error.getMessage());
            }
        });

        loadRewarded();
    }

    private void loadRewarded() {
        AdRequest req = new AdRequest.Builder().build();
        RewardedAd.load(this, TEST_REWARDED_ID, req, new RewardedAdLoadCallback() {
            @Override
            public void onAdLoaded(@NonNull RewardedAd ad) {
                rewardedAd = ad;
            }
            @Override
            public void onAdFailedToLoad(@NonNull LoadAdError e) {
                rewardedAd = null;
                Log.e("AdsBridge", "Rewarded failed to load: " + e.getMessage());
            }
        });
    }

    private void jsCallback(String js) {
        if (webView == null) return;
        webView.post(() -> webView.evaluateJavascript(js, null));
    }

    // Lifecycle management to prevent leaks
    @Override
    public void onPause() {
        super.onPause();
        if (bannerView != null) bannerView.pause();
    }

    @Override
    public void onResume() {
        super.onResume();
        if (bannerView != null) bannerView.resume();
    }

    @Override
    public void onDestroy() {
        super.onDestroy();
        if (bannerView != null) bannerView.destroy();
        rewardedAd = null;
    }

    // Handle rotation/resizing: ask JS to reposition banner
    @Override
    public void onConfigurationChanged(@NonNull Configuration newConfig) {
        super.onConfigurationChanged(newConfig);
        if (webView != null) {
            webView.evaluateJavascript("if (typeof placeBanner === 'function') placeBanner();", null);
        }
    }

    // ===== JS bridge used by HTML via window.AdsBridge =====
    public class AdsBridge {

        @JavascriptInterface
        public void showBanner() {
            runOnUiThread(() -> {
                if (bannerView != null && bannerView.getVisibility() != View.VISIBLE) {
                    bannerView.setVisibility(View.VISIBLE);
                }
            });
        }

        @JavascriptInterface
        public void hideBanner() {
            runOnUiThread(() -> {
                if (bannerView != null) bannerView.setVisibility(View.GONE);
            });
        }

        // x,y,w,h are physical pixels from JS (CSS px * devicePixelRatio)
        @JavascriptInterface
        public void positionBanner(final float x, final float y, final float width, final float height) {
            runOnUiThread(() -> {
                if (webView == null || bannerView == null) return;

                int[] loc = new int[2];
                webView.getLocationOnScreen(loc);
                int webLeft = loc[0];
                int webTop  = loc[1];

                // Current banner pixel size (for centering)
                int adW = bannerView.getAdSize().getWidthInPixels(MainActivity.this);
                int adH = bannerView.getAdSize().getHeightInPixels(MainActivity.this);

                FrameLayout.LayoutParams lp = (FrameLayout.LayoutParams) bannerView.getLayoutParams();
                lp.gravity = Gravity.TOP | Gravity.START;
                lp.leftMargin = Math.max(0, webLeft + (int)x + (int)((width - adW) / 2f));
                lp.topMargin  = Math.max(0, webTop  + (int)y + (int)((height - adH) / 2f));
                bannerView.setLayoutParams(lp);
                bannerView.bringToFront();
                bannerView.setElevation(10f);

                // Ensure an ad is loaded
                if (bannerView.getAdUnitId() != null && !bannerView.isLoading()) {
                    AdRequest adRequest = new AdRequest.Builder().build();
                    bannerView.loadAd(adRequest);
                }

                bannerView.setVisibility(View.VISIBLE);

                Log.d("AdsBridge", "pos x=" + x + " y=" + y + " w=" + width + " h=" + height);
            });
        }

        @JavascriptInterface
        public void preloadRewarded() {
            runOnUiThread(() -> { if (rewardedAd == null) loadRewarded(); });
        }

        @JavascriptInterface
        public void showRewardedForRevive() {
            runOnUiThread(() -> {
                if (rewardedAd == null) {
                    jsCallback("window.onRewardedNotAvailable && window.onRewardedNotAvailable()");
                    loadRewarded();
                    return;
                }

                pendingReward = false;

                rewardedAd.setFullScreenContentCallback(new FullScreenContentCallback() {
                    @Override public void onAdDismissedFullScreenContent() {
                        if (pendingReward) {
                            jsCallback("window.onRewardEarned && window.onRewardEarned()");
                        } else {
                            jsCallback("window.onRewardedNotAvailable && window.onRewardedNotAvailable()");
                        }
                        rewardedAd = null;
                        loadRewarded();
                    }

                    @Override public void onAdFailedToShowFullScreenContent(@NonNull AdError adError) {
                        jsCallback("window.onRewardedNotAvailable && window.onRewardedNotAvailable()");
                        rewardedAd = null;
                        loadRewarded();
                    }

                    @Override public void onAdShowedFullScreenContent() {
                        Log.d("AdsBridge", "Rewarded ad shown");
                    }
                });

                rewardedAd.show(MainActivity.this, rewardItem -> {
                    pendingReward = true; // mark as earned; JS revive occurs on dismiss
                });
            });
        }
    }
}
