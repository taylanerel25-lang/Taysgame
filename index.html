<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tay‚Äôs Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <style>
    :root{
      --bg:#87ceeb;
      --panel:rgba(255,255,255,.9);
      --panel-dark:rgba(0,0,0,.65);
      --text:#1d1d1f;
    }
    html,body{
      height:100%;
      margin:0;
      background:#111;
      color:var(--text);
      font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans";
      overscroll-behavior:none;
    }
    .wrap{position:fixed;inset:0;display:grid;place-items:center;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    canvas{background:var(--bg);box-shadow:0 10px 40px rgba(0,0,0,.35);border-radius:16px;image-rendering:pixelated;touch-action:none}
    .hud{position:fixed;inset:0;pointer-events:none;display:grid;place-items:center;font-weight:700;letter-spacing:.5px;user-select:none}
    .btn{appearance:none;border:0;background:var(--panel);color:#111;padding:8px 12px;border-radius:999px;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,.15);cursor:pointer}
    .btn:focus{outline:3px solid #000;outline-offset:2px}
    .score{position:fixed;top:18px;right:14px;font-size:28px;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.6);pointer-events:none}
    .best{position:fixed;top:18px;left:14px;font-size:16px;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.6);pointer-events:none}
    .splash{position:absolute;inset:0;pointer-events:none;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.5)}
    .splash-inner{position:absolute;left:50%;transform:translateX(-50%);top:10%;width:min(92%,360px);text-align:center;pointer-events:none}
    .title{font-size:36px;margin:2px 0 8px}
    .subtitle{font-size:18px;opacity:.95}
    .splash-board{position:absolute;left:50%;transform:translateX(-50%);bottom:18px;width:min(92%,360px);background:rgba(0,0,0,.65);color:#f0f0f0;border-radius:18px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25);pointer-events:auto}
    .board-head{font-size:20px;font-weight:800;text-align:center;margin:0 0 6px}
    .board-row{display:flex;justify-content:space-between;align-items:center;font-size:16px;padding:6px 0}
    .panel{min-width:280px;max-width:90vw;background:var(--panel);color:#111;border-radius:18px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25);pointer-events:auto;transform:translateY(8px)}
    .panel h2{margin:0 0 8px 0;font-size:22px;text-align:center}
    .panel .row{display:flex;justify-content:space-between;align-items:center;font-size:18px;padding:6px 0}
    .panel .actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:rgba(0,0,0,.08);padding:4px 10px;border-radius:999px;font-size:14px}
    .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:8px 12px;border-radius:10px;font-size:14px;pointer-events:none;opacity:0;transition:opacity .25s ease,transform .25s ease}
    .toast.show{opacity:1;transform:translate(-50%,-6px)}
    /* Sound button ‚Äì pinned top center */
    .soundbar{position:fixed;top:12px;left:50%;transform:translateX(-50%);pointer-events:auto}
    /* Name modal */
    .name-modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35)}
    .name-card{width:min(92%,360px);background:#fff;color:#111;border-radius:18px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .name-card h3{margin:0 0 8px 0;text-align:center}
    .name-row{display:flex;gap:8px;margin-top:10px}
    .name-row input{flex:1;border-radius:12px;border:2px solid #ddd;padding:10px 12px;font-size:16px}
    .name-row button{white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="360" height="640" aria-label="Tay‚Äôs Game canvas"></canvas>
  </div>

  <!-- HUD -->
  <div class="hud" aria-hidden="true">
    <div class="soundbar"><button id="muteBtn" class="btn" aria-pressed="false" aria-label="Toggle sound">üîä Sound</button></div>
    <div id="scoreHud" class="score">0</div>
    <div id="bestHud" class="best">Highest: 0</div>

    <!-- Splash (title + instructions) -->
    <div id="splash" class="splash">
      <div class="splash-inner">
        <div class="title">Tay‚Äôs Game ‚ù§Ô∏è</div>
        <div class="subtitle">Tap / Click / Space to start</div>
        <div style="margin-top:6px;font-size:14px;opacity:.9">Avoid the pipes, collect coins. Good luck!</div>
      </div>

      <!-- Leaderboard on splash (bottom) -->
      <div id="splashBoard" class="splash-board">
        <div class="board-head">üèÜ Leaderboard</div>
        <div id="leaderboardSplashBody" style="font-size:16px;text-align:center;">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Game Over panel -->
  <div id="gameOver" class="hud" style="display:none;">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="overTitle">
      <h2 id="overTitle">Game Over</h2>
      <div class="row"><span>Your Score</span><strong id="scoreNow">0</strong></div>
      <div class="row"><span>Highest Score</span><span><strong id="bestNow">0</strong> <span id="medal" class="pill" aria-label="medal" style="display:none;">ü•â Bronze</span></span></div>
      <div class="actions">
        <button id="againBtn" class="btn">Play Again</button>
        <button id="shareBtn" class="btn">Share</button>
      </div>

      <!-- Leaderboard inside Game Over -->
      <div id="leaderboardOver" class="panel dark" style="margin-top:12px;padding:12px;">
        <div style="text-align:center;font-weight:800;">üèÜ Leaderboard</div>
        <div id="leaderboardOverBody" style="margin-top:6px;font-size:16px;">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Name modal (first run or if name cleared) -->
  <div id="nameModal" class="name-modal" role="dialog" aria-modal="true" aria-labelledby="nameTitle">
    <div class="name-card">
      <h3 id="nameTitle">Welcome! Enter your name</h3>
      <p style="margin:0 0 6px 0;text-align:center;opacity:.8;font-size:14px;">It‚Äôll appear on the leaderboard across all devices.</p>
    <div class="name-row">
        <input id="playerNameInput" type="text" placeholder="e.g. Tay" maxlength="24" />
        <button id="saveNameBtn" class="btn">Save</button>
      </div>
    </div>
  </div>

  <div id="aria" class="sr-only" aria-live="polite"></div>
  <div id="toast" class="toast" role="status"></div>

  <!-- ================== GAME CODE ================== -->
  <script>
(() => {
  'use strict';

  /* ========= CONFIG ========= */
  const CFG = {
    canvas: { width: 360, height: 640 },
    physics: { gravity: 1800, flapImpulse: -420, maxFallSpeed: 900 },
    world: { speedStart: 180, speedEnd: 240, speedEndScore: 30 },
    pipes: {
      gapStart: 160, gapEnd: 135, gapEndScore: 20,
      spawnStart: 1.2, spawnEnd: 0.95, spawnEndScore: 25,
      minGapCenterY: 120, maxGapCenterYPaddingBottom: 120, width: 64
    },
    bird: { size: { w: 34, h: 24 }, hitboxRadius: 12 },
    ground: { height: 112 },
    scorePopup: { dy: 40, duration: 0.6 },
    birdIdleBobPx: 4,
    particles: { max: 50, flapCount: 3, collectCount: 5 },
    collectibles: { chance: 0.3, bonus: 5, size: 16 }
  };

  const DPR = Math.min(window.devicePixelRatio || 1, 3);

  /* ========= DOM ========= */
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const splashEl = document.getElementById('splash');
  const hudScore = document.getElementById('scoreHud');
  const overPanel = document.getElementById('gameOver');
  const scoreNow = document.getElementById('scoreNow');
  const bestNow = document.getElementById('bestNow');
  const medalEl = document.getElementById('medal');
  const muteBtn = document.getElementById('muteBtn');
  const ariaLive = document.getElementById('aria');
  const toast = document.getElementById('toast');

  const nameModal = document.getElementById('nameModal');
  const nameInput = document.getElementById('playerNameInput');
  const saveNameBtn = document.getElementById('saveNameBtn');

  /* ========= STATE ========= */
  const W = CFG.canvas.width, H = CFG.canvas.height;
  const groundY = H - CFG.ground.height;

  let state = 'ready'; // 'ready' | 'running' | 'dead'
  let paused = false;
  let worldTime = 0;
  let spawnTimer = 0;
  let lastMs = performance.now();

  const storage = {
    best: Number(localStorage.getItem('sb_best') || 0),
    muted: localStorage.getItem('sb_muted') === '1'
  };

  if (storage.muted){
    muteBtn.setAttribute('aria-pressed','true');
    muteBtn.textContent='üîá Muted';
  }

  const BIRD_X = Math.round(W * 0.28);
  let bird = { x: BIRD_X, y: H*0.5, vy: 0, rot: 0, frame: 0, frameTimer: 0 };

  const pipes = [];
  const pops = [];
  const cloudsFg = [ // Foreground clouds, faster
    { x: 40,  y: 100, s: 0.30 },
    { x: 240, y: 60,  s: 0.25 },
    { x: 170, y: 140, s: 0.22 }
  ];
  const cloudsBg = [ // Background clouds, slower for parallax
    { x: 100, y: 80, s: 0.15 },
    { x: 300, y: 120, s: 0.12 },
    { x: 200, y: 50, s: 0.18 }
  ];

  let score = 0;
  let multiplier = 1;
  window.score = 0; // expose for Firebase block

  let collectibles = [];
  const particles = [];

  const medalFor = (s) => s>=50?['üèÜ Platinum','#e5e4e2']:s>=30?['ü•á Gold','#f7c32e']:s>=20?['ü•à Silver','#c0c0c0']:s>=10?['ü•â Bronze','#cd7f32']:null;

  /* ========= STAGES ========= */
  const stageSkies = ['#87ceeb','#ffa366','#9966cc','#1a1a2e','#ffe680'];
  const stagePipes = ['#2fbf59','#ff9933','#aa66cc','#e74c3c','#ffcc00'];
  let lastStage = -1;
  const currentStage = () => Math.min(Math.floor(score/10), stageSkies.length-1);
  const onStageChange = () => { showToast(`Stage ${currentStage()+1}!`); };

  /* ========= AUDIO ========= */
  let audioCtx = null;
  const beep = (type,freq,dur,vol=0.2)=>{
    if(!audioCtx || storage.muted) return;
    try {
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=vol;
      o.connect(g).connect(audioCtx.destination);
      const t=audioCtx.currentTime;
      o.start(t); g.gain.exponentialRampToValueAtTime(0.0001,t+dur*0.9); o.stop(t+dur);
    } catch (e) {
      console.warn('Audio playback failed:', e); // Prevent freeze from errors
    }
  };
  const sfx = {
    flap: ()=>beep('square',600,0.08,0.15),
    point:()=>beep('triangle',880,0.07,0.18),
    hit:  ()=>beep('sawtooth',120,0.15,0.22),
    die:  ()=>beep('sine',80,0.35,0.25),
    swoosh:()=>beep('triangle',300,0.1,0.12),
    collect:()=>beep('sine',1200,0.1,0.2)
  };

  /* ========= HELPERS ========= */
  const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
  const lerp=(a,b,t)=>a+(b-a)*t;
  const easeT=(s,end)=>clamp(s/end,0,1);
  const pipeGap = ()=> (window.dynamicPipeGap ?? lerp(CFG.pipes.gapStart, CFG.pipes.gapEnd, easeT(score, CFG.pipes.gapEndScore)));
  const spawnInterval = ()=> lerp(CFG.pipes.spawnStart, CFG.pipes.spawnEnd, easeT(score, CFG.pipes.spawnEndScore));
  const speedBase = ()=> lerp(CFG.world.speedStart, CFG.world.speedEnd, easeT(score, CFG.world.speedEndScore));
  const showToast = (msg)=>{ toast.textContent=msg; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'),1200); };
  const announce=(msg)=>{ const a=document.getElementById('aria'); a.textContent=''; setTimeout(()=>a.textContent=msg,30); };

  function resetGame(){
    score=0; multiplier=1; hudScore.textContent='0'; worldTime=0; spawnTimer=-0.5;
    pipes.length=0; pops.length=0; collectibles.length=0; particles.length=0;
    bird={ x:BIRD_X, y:H*0.5, vy:0, rot:0, frame:0, frameTimer:0 };
    sfx.swoosh(); lastStage=-1;
    document.getElementById('bestHud').textContent=`Highest: ${storage.best}`;
  }

  /* ========= DPR / RESIZE ========= */
  function fitCanvas(){
    const aspect=W/H;
    const vw=innerWidth, vh=innerHeight;
    let cssW, cssH;
    if(vw/vh<aspect){ cssW=Math.min(vw,W*2.5); cssH=Math.round(cssW/aspect); }
    else { cssH=Math.min(vh,H*2.5); cssW=Math.round(cssH*aspect); }
    canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px';
    canvas.width=Math.round(W*DPR); canvas.height=Math.round(H*DPR);
    ctx.setTransform(1,0,0,1,0,0); ctx.scale(DPR,DPR); ctx.imageSmoothingEnabled=false;
  }
  addEventListener('resize',fitCanvas,{passive:true}); fitCanvas();

  /* ========= INPUT ========= */
  const flap=()=>{
    if(state==='dead') return;

    // Initialize audio on first user gesture (tap/start)
    if (!audioCtx) {
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioCtx.resume().catch((e) => console.warn('Audio resume failed:', e));
      } catch (e) {
        console.warn('AudioContext creation failed:', e);
      }
    }

    // Require name before first play
    if(!localStorage.getItem('player_name')){
      openNameModal();
      return;
    }

    if(state==='ready'){
      state='running';
      announce('Game started');
      splashEl.style.display='none';
    }
    bird.vy=CFG.physics.flapImpulse; sfx.flap();
    // Add flap particles
    for(let i=0; i<CFG.particles.flapCount; i++){
      particles.push({
        x: bird.x - CFG.bird.size.w/2 + Math.random()*10,
        y: bird.y + Math.random()*CFG.bird.size.h - CFG.bird.size.h/2,
        vx: -speedBase()*0.5 + Math.random()*50 - 25,
        vy: Math.random()*100 - 50,
        life: 0.5 + Math.random()*0.5,
        size: 2 + Math.random()*2,
        color: '#ffd84a',
        t: 0
      });
    }
  };
  canvas.addEventListener('mousedown',e=>{e.preventDefault();flap();});
  canvas.addEventListener('touchstart',e=>{e.preventDefault();flap();},{passive:false});
  addEventListener('keydown',e=>{
    const k=e.key.toLowerCase();
    if([' ','w','arrowup'].includes(k)){e.preventDefault();flap();}
    if(k==='p' && state==='running'){ paused=!paused; showToast(paused?'Paused':'Resumed'); }
  },{passive:false});

  /* ========= UI ========= */
  muteBtn.addEventListener('click',()=>{
    storage.muted=!storage.muted; localStorage.setItem('sb_muted',storage.muted?'1':'0');
    muteBtn.setAttribute('aria-pressed',storage.muted?'true':'false');
    muteBtn.textContent=storage.muted ? 'üîá Muted' : 'üîä Sound';
  });

  document.getElementById('againBtn').addEventListener('click',()=>{
    overPanel.style.display='none'; splashEl.style.display='';
    state='ready'; resetGame(); announce('Back to splash');
  });
  document.getElementById('shareBtn').addEventListener('click',async()=>{
    const text=`I scored ${scoreNow.textContent} in Tay‚Äôs Game! Can you beat me?`;
    try{ if(navigator.share) await navigator.share({text,title:"Tay‚Äôs Game"}); else { await navigator.clipboard.writeText(text); showToast('Copied to clipboard!'); } } catch {}
  });

  /* ========= NAME MODAL ========= */
  function openNameModal(){
    nameModal.style.display='grid';
    nameInput.value=localStorage.getItem('player_name')||'';
    setTimeout(()=>nameInput.focus(),10);
  }
  function saveName(){
    const raw=(nameInput.value||'').trim();
    const clean = raw.replace(/[.#$/\[\]\/]/g,'').slice(0,24); // sanitize for RTDB key
    if(!clean){ showToast('Please enter a name'); nameInput.focus(); return; }
    localStorage.setItem('player_name',clean);
    nameModal.style.display='none';
    showToast(`Hi, ${clean}!`);
  }
  saveNameBtn.addEventListener('click',saveName);
  nameInput.addEventListener('keydown',e=>{ if(e.key==='Enter') saveName(); });

  /* ========= GAME LOGIC ========= */
  function spawnPipe(){
    const gap=pipeGap();
    const padBottom=CFG.pipes.maxGapCenterYPaddingBottom;
    const minC=CFG.pipes.minGapCenterY;
    const maxCenter=(groundY-padBottom)-gap/2;
    const minCenter=minC+gap/2;
    let gapY=Math.round(lerp(minCenter,maxCenter,Math.random()));
    pipes.push({ x:W+10, gapY, gap, w:CFG.pipes.width, scored:false });

    // Spawn collectible sometimes
    if(Math.random() < CFG.collectibles.chance){
      const collY = gapY + (Math.random() - 0.5) * (gap - CFG.collectibles.size * 2);
      collectibles.push({ x: W + 10 + CFG.pipes.width / 2, y: collY, collected: false });
    }
  }

  function update(dt){
    if(state!=='running' || paused) return;
    const speed=speedBase();
    worldTime+=dt; spawnTimer+=dt;

    if(spawnTimer>=spawnInterval()){ spawnTimer=0; spawnPipe(); }

    for(const c of cloudsFg){ c.x-=speed*c.s*dt; if(c.x<-80) c.x+=W+160; }
    for(const c of cloudsBg){ c.x-=speed*c.s*dt; if(c.x<-80) c.x+=W+160; }

    bird.vy+=CFG.physics.gravity*dt;
    bird.vy=clamp(bird.vy,-9999,CFG.physics.maxFallSpeed);
    bird.y+=bird.vy*dt; bird.y=clamp(bird.y,2,H+1000);

    const targetRot = bird.vy<0 ? -25*Math.PI/180
      : Math.min(90*Math.PI/180, bird.vy/CFG.physics.maxFallSpeed*(90*Math.PI/180));
    bird.rot = lerp(bird.rot, targetRot, 0.12);

    const animFps = bird.vy<0 ? 8 : 4;
    bird.frameTimer+=dt; if(bird.frameTimer>=1/animFps){ bird.frame=(bird.frame+1)%3; bird.frameTimer=0; }

    for(const p of pipes){
      p.x-=speed*dt;
      const cx=p.x+p.w/2;
      if(!p.scored && cx<bird.x){
        p.scored=true;
        const addScore = Math.round(1 * multiplier);
        score += addScore; hudScore.textContent=String(score);
        window.score=score;

        if(score>storage.best){
          storage.best=score;
          localStorage.setItem('sb_best',String(score));
          document.getElementById('bestHud').textContent=`Highest: ${storage.best}`;
        }

        pops.push({ x:cx, y:p.gapY, t:0, duration:CFG.scorePopup.duration, text:`+${addScore}` });
        if(navigator.vibrate) navigator.vibrate(20);
        sfx.point(); announce(`Score ${score}`);

        const st=currentStage(); if(st!==lastStage){ lastStage=st; onStageChange(); }

        // Multiplier increase every 5 pipes
        if(score % 5 === 0) { multiplier += 0.1; showToast(`Multiplier x${multiplier.toFixed(1)}!`); }
      }
    }
    while(pipes.length && pipes[0].x+pipes[0].w<-20) pipes.shift();

    // Update collectibles
    for(const coll of collectibles){
      coll.x -= speed * dt;
      if(!coll.collected && Math.hypot(bird.x - coll.x, bird.y - coll.y) < CFG.bird.hitboxRadius + CFG.collectibles.size / 2){
        coll.collected = true;
        score += CFG.collectibles.bonus; hudScore.textContent=String(score);
        sfx.collect(); showToast(`+${CFG.collectibles.bonus} Bonus!`);
        // Add collect particles
        for(let i=0; i<CFG.particles.collectCount; i++){
          particles.push({
            x: coll.x,
            y: coll.y,
            vx: Math.random()*100 - 50,
            vy: Math.random()*100 - 150,
            life: 0.8 + Math.random()*0.4,
            size: 3 + Math.random()*3,
            color: '#ffcc00',
            t: 0
          });
        }
      }
    }
    collectibles = collectibles.filter(c => c.x > -20 && !c.collected);

    // Collisions
    const r=CFG.bird.hitboxRadius;
    const circle={ x:bird.x+2, y:bird.y, r };
    const penetrationNeeded=0.2*r;
    let hit=false;
    for(const p of pipes){
      const topRect={ x:p.x, y:-10000, w:p.w, h:(p.gapY-p.gap/2)+10000 };
      const botRect={ x:p.x, y:(p.gapY+p.gap/2), w:p.w, h:(groundY-(p.gapY+p.gap/2)) };
      if(circleRectDeepOverlap(circle,topRect,penetrationNeeded) || circleRectDeepOverlap(circle,botRect,penetrationNeeded)){ hit=true; break; }
    }
    if(circle.y+circle.r>=groundY){ die(); return; }
    if(hit){ sfx.hit(); die(); }

    for(let i=pops.length-1;i>=0;i--){ const pop=pops[i]; pop.t+=dt; if(pop.t>=pop.duration) pops.splice(i,1); }

    // Update particles
    for(let i=particles.length-1; i>=0; i--){
      const p = particles[i];
      p.t += dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.vy += CFG.physics.gravity * 0.2 * dt; // Light gravity
      if(p.t >= p.life) particles.splice(i,1);
    }
  }

  function circleRectDeepOverlap(circ,rect,needed){
    const nx=clamp(circ.x,rect.x,rect.x+rect.w);
    const ny=clamp(circ.y,rect.y,rect.y+rect.h);
    const dx=circ.x-nx, dy=circ.y-ny;
    const dist=Math.hypot(dx,dy);
    const overlap=circ.r-dist;
    return overlap>needed;
  }

  function die(){
    state='dead'; paused=false;
    if(navigator.vibrate) navigator.vibrate(80);
    sfx.die();

    const fallUntil=()=>{
      const now=performance.now();
      const dt=Math.min((now-lastMs)/1000,1/30);
      lastMs=now;
      bird.vy+=CFG.physics.gravity*dt;
      bird.vy=Math.min(bird.vy,CFG.physics.maxFallSpeed);
      bird.y+=bird.vy*dt;
      bird.rot=lerp(bird.rot,90*Math.PI/180,0.12);
      render();
      if(bird.y+CFG.bird.hitboxRadius<groundY) requestAnimationFrame(fallUntil);
      else { bird.y=groundY-CFG.bird.hitboxRadius; setTimeout(showGameOver,800); }
    };
    fallUntil();
  }

  function showGameOver(){
    scoreNow.textContent=String(score);
    if(score>storage.best){ storage.best=score; localStorage.setItem('sb_best',String(score)); }
    bestNow.textContent=String(storage.best);
    document.getElementById('bestHud').textContent=`Highest: ${storage.best}`;
    const m=medalFor(storage.best); if(m){ medalEl.style.display=''; medalEl.textContent=m[0]; } else medalEl.style.display='none';
    overPanel.style.display='';
  }
  window.showGameOver=showGameOver;

  /* ========= RENDER ========= */
  function roundedRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }
  function drawClouds(clouds, opacity=0.9){
    for(const c of clouds){
      ctx.save(); ctx.translate(c.x,c.y);
      ctx.fillStyle=`rgba(255,255,255,${opacity})`;
      roundedRect(-20,-10,40,20,8); roundedRect(5,-14,30,18,8); roundedRect(-35,-8,26,16,8);
      ctx.fill(); ctx.restore();
    }
  }
  function drawPipes(){
    const stage=currentStage();
    const baseColor=stagePipes[stage]; 
    const dark='rgba(0,0,0,.18)';
    for(const p of pipes){
      const topH=p.gapY-p.gap/2;
      const botY=p.gapY+p.gap/2;
      const botH=groundY-botY;
      const persp = 8; // Perspective taper amount

      // Radial gradient for 3D cylindrical look
      const grad = ctx.createRadialGradient(p.x + p.w/2, 0, p.w/2, p.x + p.w/2, 0, 0);
      grad.addColorStop(0, baseColor);
      grad.addColorStop(0.7, '#ffffff40'); // Highlight
      grad.addColorStop(1, dark); // Shadow

      // Top pipe with perspective (wider at bottom)
      ctx.fillStyle=grad; 
      ctx.beginPath();
      ctx.moveTo(p.x, 0);
      ctx.lineTo(p.x + p.w, 0);
      ctx.lineTo(p.x + p.w + persp, topH);
      ctx.lineTo(p.x - persp, topH);
      ctx.closePath();
      ctx.fill();

      // Bottom pipe with perspective (wider at top)
      ctx.beginPath();
      ctx.moveTo(p.x - persp, botY);
      ctx.lineTo(p.x + p.w + persp, botY);
      ctx.lineTo(p.x + p.w, groundY);
      ctx.lineTo(p.x, groundY);
      ctx.closePath();
      ctx.fill();

      // Bevel on caps for 3D depth
      ctx.fillStyle=dark;  
      roundedRect(p.x-4,topH-16,p.w+8,16,4); ctx.fill();
      roundedRect(p.x-4,botY,p.w+8,16,4); ctx.fill();

      // Vertical shadow stripes for tube effect
      ctx.fillStyle='rgba(0,0,0,.12)'; 
      ctx.fillRect(p.x+6,0,4,topH); 
      ctx.fillRect(p.x+6,botY,4,botH);
      ctx.fillRect(p.x+p.w-10,0,4,topH); 
      ctx.fillRect(p.x+p.w-10,botY,4,botH);
    }
  }
  function drawBird(){
    ctx.save();
    const w=CFG.bird.size.w, h=CFG.bird.size.h, r=CFG.bird.hitboxRadius;
    const idleBob=(state==='ready') ? Math.sin(worldTime*Math.PI*4)*CFG.birdIdleBobPx : 0;
    ctx.translate(bird.x,bird.y+idleBob); ctx.rotate(bird.rot);

    // Linear gradient for 3D body shading, dynamic based on rotation
    const bodyGrad = ctx.createLinearGradient(-w/2, -h/2, -w/2, h/2);
    bodyGrad.addColorStop(0, lerpColor('#ffe066', '#cc9e00', Math.sin(bird.rot))); // Adjust shade with rot
    bodyGrad.addColorStop(1, '#ffd84a'); // Base yellow bottom
    ctx.fillStyle=bodyGrad; 
    roundedRect(-w/2,-h/2,w,h,6); ctx.fill();

    // Belly with gradient
    const bellyGrad = ctx.createLinearGradient(-w*0.2, -h*0.15, w*0.6, h*0.55);
    bellyGrad.addColorStop(0, '#ffffff'); // Bright white
    bellyGrad.addColorStop(1, '#fff2b2'); // Softer
    ctx.fillStyle=bellyGrad; 
    roundedRect(-w*0.2,-h*0.15,w*0.8,h*0.7,6); ctx.fill();

    // Eye with bevel/shadow
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(w*0.1,-h*0.1,4,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(0,0,0,0.2)'; ctx.beginPath(); ctx.arc(w*0.1+1,-h*0.1+1,4,0,Math.PI*2); ctx.fill(); // Shadow layer
    ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(w*0.1+1,-h*0.1,2,0,Math.PI*2); ctx.fill();

    // Beak with gradient for 3D
    const beakGrad = ctx.createLinearGradient(w*0.25, -3, w*0.45, 3);
    beakGrad.addColorStop(0, '#ffc04d'); // Lighter edge
    beakGrad.addColorStop(1, '#ff9a00'); // Darker base
    ctx.fillStyle=beakGrad; 
    ctx.beginPath(); ctx.moveTo(w*0.45,0); ctx.lineTo(w*0.25,-3); ctx.lineTo(w*0.25,3); ctx.closePath(); ctx.fill();

    // Wing with gradient and position
    const f=bird.frame; const wy=f===0?-2:f===1?0:2;
    ctx.save(); ctx.translate(-4,wy); 
    const wingGrad = ctx.createLinearGradient(-10, -6, 8, 6);
    wingGrad.addColorStop(0, '#ffd966'); // Light top
    wingGrad.addColorStop(1, '#f7bf3c'); // Dark bottom
    ctx.fillStyle=wingGrad; 
    roundedRect(-10,-6,18,12,6); ctx.fill(); 
    ctx.restore();

    ctx.restore();
    // Dynamic shadow under bird for overall 3D lift, based on height
    ctx.save();
    const shadowScale = 1 - (bird.y / groundY) * 0.5; // Smaller shadow when higher
    ctx.translate(bird.x, groundY - 4);
    ctx.fillStyle='rgba(0,0,0,0.15)'; 
    ctx.beginPath(); ctx.ellipse(0, 0, (w/2 - 2) * shadowScale, 3 * shadowScale, 0, 0, Math.PI * 2); ctx.fill();
    ctx.restore();
  }
  function drawGround(){
    const speed=speedBase();
    const t=(worldTime*speed)%48;
    const y=groundY;
    ctx.fillStyle='#e6a65d'; ctx.fillRect(0,y,W,H-y);
    ctx.fillStyle='#68c151'; ctx.fillRect(0,y-8,W,8);
    ctx.fillStyle='rgba(0,0,0,.06)';
    for(let x=-t;x<W;x+=48){ ctx.fillRect(x,y+6,24,6); ctx.fillRect(x+24,y+16,24,6); }
  }
  function drawCollectibles(){
    for(const coll of collectibles){
      if(coll.collected) continue;
      const grad = ctx.createRadialGradient(coll.x, coll.y, 0, coll.x, coll.y, CFG.collectibles.size / 2);
      grad.addColorStop(0, '#ffff99');
      grad.addColorStop(1, '#ffcc00');
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(coll.x, coll.y, CFG.collectibles.size / 2, 0, Math.PI * 2);
      ctx.fill();
    }
  }
  function drawParticles(){
    for(const p of particles){
      const t = p.t / p.life;
      ctx.globalAlpha = 1 - t;
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size * (1 - t), 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }
  function lerpColor(a, b, t) {
    const ah = parseInt(a.replace(/#/g, ''), 16),
          ar = ah >> 16, ag = ah >> 8 & 0xff, ab = ah & 0xff,
          bh = parseInt(b.replace(/#/g, ''), 16),
          br = bh >> 16, bg = bh >> 8 & 0xff, bb = bh & 0xff,
          rr = ar + t * (br - ar),
          rg = ag + t * (bg - ag),
          rb = ab + t * (bb - ab);
    return '#' + ((1 << 24) + (rr << 16) + (rg << 8) + rb | 0).toString(16).slice(1);
  }

  function render(){
    const stage=currentStage();
    const sky=stageSkies[stage];
    canvas.style.background=sky;

    ctx.save();
    ctx.fillStyle=sky; ctx.fillRect(0,0,W,H);

    drawClouds(cloudsBg, 0.6); // Background parallax layer
    drawClouds(cloudsFg); // Foreground
    drawPipes();
    drawCollectibles();
    drawBird();
    drawParticles();
    drawGround();

    for(const pop of pops){
      const t=clamp(pop.t/pop.duration,0,1);
      const y=pop.y - t*CFG.scorePopup.dy;
      ctx.globalAlpha=1-t;
      ctx.fillStyle='#fff'; ctx.font='bold 20px ui-rounded, system-ui, sans-serif'; ctx.textAlign='center';
      ctx.fillText(pop.text,pop.x,y);
      ctx.globalAlpha=1;
    }

    ctx.restore();
  }

  /* ========= LOOP ========= */
  function loop(now){
    try {
      const dt=clamp((now-lastMs)/1000,0,1/30);
      lastMs=now;
      if(state==='ready') worldTime+=dt;
      else if(state==='running' && !paused){ worldTime+=dt; update(dt); }
      render();
    } catch (e) {
      console.error('Game loop error:', e);
    }
    requestAnimationFrame(loop);
  }

  /* ========= INIT ========= */
  function init(){
    resetGame();
    splashEl.style.display='';
    hudScore.textContent='0';
    document.getElementById('bestHud').textContent=`Highest: ${storage.best}`;
    bestNow.textContent=String(storage.best);
    overPanel.style.display='none';
    lastMs=performance.now();
    requestAnimationFrame(loop);

    // If no name, prompt on splash
    if(!localStorage.getItem('player_name')) openNameModal();
  }
  init();
})();
  </script>
  <!-- =============== Firebase (Leaderboard + Remote Config + Analytics + Auth) =============== -->
  <script type="module">
    try {
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import { getDatabase, ref, push, get, set, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
      import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
      import { getRemoteConfig, fetchAndActivate, getValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-remote-config.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

      // Your Firebase app config
      const firebaseConfig = {
        apiKey: "********",
        authDomain: "********",
        databaseURL: "********",
        projectId: "********",
        storageBucket: "********",
        messagingSenderId: "********",
        appId: "********",
        measurementId: "********"
      };

      // Init
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const analytics = getAnalytics(app);

      // ---------- Auth: sign in anonymously (ensures write access if rules require auth) ----------
      const auth = getAuth(app);
      const authReady = new Promise((resolve) => {
        onAuthStateChanged(auth, (user) => {
          if (user) { resolve(user); }
        });
      });
      // Kick off anon sign-in if needed
      signInAnonymously(auth).catch((e)=>console.warn("Anonymous auth failed:", e));

      // ---------- Remote Config: dynamic pipe gap (optional) ----------
      const rc = getRemoteConfig(app);
      rc.settings.minimumFetchIntervalMillis = 60000;
      rc.defaultConfig = { current_pipe_gap_size: 160 };
      async function loadAdaptiveDifficulty(){
        try{
          await fetchAndActivate(rc);
          const val = Number(getValue(rc,"current_pipe_gap_size")._value);
          if(!Number.isNaN(val) && val>60 && val<400){
            window.dynamicPipeGap = val;
            console.log("Remote pipe gap:", val);
          }
        }catch(e){ console.warn("Remote Config failed", e); }
      }
      loadAdaptiveDifficulty();

      // ---------- Leaderboard helpers ----------
      const sanitize = (name)=> String(name||"Anonymous").trim().replace(/[.#$/\[\]\/]/g,"_").toLowerCase();

      async function updatePlayerBest(name, score){
        const cleanKey = sanitize(name);
        const bestRef = ref(db, "bests/" + cleanKey);
        try {
          const snap = await get(bestRef);
          const prev = snap.exists() ? Number(snap.val().bestScore||0) : 0;
          if(score > prev){
            await set(bestRef, { name: name || "Anonymous", bestScore: score, updatedAt: Date.now() });
          }
        } catch (e) {
          console.warn("updatePlayerBest failed:", e);
        }
      }

      function renderBoard(container, entries){
        if(!container) return;
        if(!entries.length){
          container.innerHTML = "<div style='text-align:center;opacity:.9'>No scores yet</div>";
          return;
        }
        container.innerHTML = entries
          .map((e,i)=>`<div class="board-row"><span>${i+1}. ${e.name}</span><strong>${e.score}</strong></div>`).join("");
      }

      function convertBestsToList(obj){
        if(!obj) return [];
        return Object.values(obj)
          .map(e=>({ name: e.name || "Anonymous", score: Number(e.bestScore||0) }))
          .filter(e=>Number.isFinite(e.score))
          .sort((a,b)=>b.score-a.score)
          .slice(0,10);
      }

      // Live listeners (so all devices see updates instantly)
      function startLiveLeaderboards(){
        const splashBody = document.getElementById("leaderboardSplashBody");
        const overBody = document.getElementById("leaderboardOverBody");
        const bestsRef = ref(db, "bests");
        onValue(bestsRef, (snap)=>{
          try{
            const top = convertBestsToList(snap.val());
            renderBoard(splashBody, top);
            renderBoard(overBody, top);
          }catch(e){
            console.warn("Render leaderboard failed:", e);
            if(splashBody) splashBody.innerHTML = "<div style='text-align:center;opacity:.9'>Couldn‚Äôt load leaderboard</div>";
            if(overBody) overBody.innerHTML = "<div style='text-align:center;opacity:.9'>Couldn‚Äôt load leaderboard</div>";
          }
        }, (err)=>{
          console.warn("Leaderboard listener error:", err);
          const splashBody = document.getElementById("leaderboardSplashBody");
          const overBody = document.getElementById("leaderboardOverBody");
          if(splashBody) splashBody.innerHTML = "<div style='text-align:center;opacity:.9'>Couldn‚Äôt load leaderboard</div>";
          if(overBody) overBody.innerHTML = "<div style='text-align:center;opacity:.9'>Couldn‚Äôt load leaderboard</div>";
        });
      }

      // Start listeners right away
      startLiveLeaderboards();

      // ---------- Submit on Game Over ----------
      const originalShowGameOver = window.showGameOver;
      window.showGameOver = async function(...args){
        if (typeof originalShowGameOver === "function") originalShowGameOver(...args);

        const scoreVal = Number(window.score || 0);
        try { logEvent(analytics, "game_over", { score: scoreVal }); } catch {}

        let name = localStorage.getItem("player_name") || "";
        if(!name){
          // Fallback prompt if name modal wasn‚Äôt used for some reason
          name = prompt("Enter your name for the leaderboard:") || "Anonymous";
          localStorage.setItem("player_name", name.replace(/[.#$/\[\]\/]/g,"").slice(0,24));
        }

        try{
          // Ensure auth is ready in case rules require it
          await authReady;

          // Save a raw row in /leaderboard (history) and update best
          await push(ref(db, "leaderboard"), { name: name || "Anonymous", score: scoreVal, date: Date.now() });
          await updatePlayerBest(name, scoreVal);
          // live listeners will refresh the UI automatically
        }catch(e){
          console.warn("Score submit failed:", e);
          const toast=document.getElementById("toast");
          toast.textContent="Couldn‚Äôt submit score"; toast.classList.add("show");
          setTimeout(()=>toast.classList.remove("show"),1500);
        }
      };
    } catch (e) {
      console.warn('Firebase initialization failed:', e);
      // Fallback: Disable leaderboards if Firebase fails
      document.getElementById("leaderboardSplashBody").innerHTML = "<div style='text-align:center;opacity:.9'>Leaderboard unavailable</div>";
      document.getElementById("leaderboardOverBody").innerHTML = "<div style='text-align:center;opacity:.9'>Leaderboard unavailable</div>";
    }
  </script>
</body>
</html>
