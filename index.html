<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Flappy Fly</title>
  <meta name="description" content="A single-file, mobile-first Flappy Bird-style game. Tap/Click/Space to flap!" />
  <style>
    :root{
      --bg:#8fd3ff;
      --ink:#0b0e1a;
      --ui:#101423cc;
      --ui-border:#2a2f4a66;
      --accent:#ffd24a;
    }
    html,body{height:100%;margin:0;background:linear-gradient(#8fd3ff, #b9e7ff 60%, #e9f7ff);color:#fff;font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;}
    *{box-sizing:border-box}
    #app{min-height:100%;display:grid;place-items:center;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
    canvas{touch-action:none;background:transparent;display:block;max-width:100vw;height:auto;border-radius:16px;box-shadow:0 10px 40px #0005;border:1px solid #0002}
    #hud{position:fixed;inset:auto 0 0 0;display:flex;justify-content:center;gap:8px;padding:10px;pointer-events:none}
    .chip{pointer-events:auto;background:var(--ui);border:1px solid var(--ui-border);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);padding:8px 12px;border-radius:999px;font-size:14px;color:#e6e8f0}
    .chip input{vertical-align:middle}
    #scoreText{position:fixed;top:10px;left:0;right:0;text-align:center;font-weight:800;font-size:42px;text-shadow:0 3px 0 #0007,0 0 10px #0005}
    #bigPopup{position:fixed;top:40%;left:0;right:0;text-align:center;font-weight:900;font-size:68px;opacity:0;transform:translateY(10px);text-shadow:0 4px 0 #0007}
    #overlay{position:fixed;inset:0;display:none;place-items:center;background:#0008}
    #overlay.show{display:grid}
    #panel{background:#1b2035;color:#fff;border:1px solid #2a2f4a;border-radius:16px;padding:16px;width:min(320px,92vw);box-shadow:0 10px 30px #0007}
    #panel h2{margin:0 0 12px 0}
    #panel .row{display:flex;justify-content:space-between;margin:6px 0}
    #panel button{width:100%;margin-top:12px;padding:10px 14px;border-radius:12px;border:1px solid #2a2f4a;background:#2a3050;color:#fff;cursor:pointer}
    #panel button:hover{filter:brightness(1.08)}
    #a11y{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}
    #paused{position:fixed;inset:0;display:none;place-items:center;background:#0006;color:#fff;font-weight:700;font-size:28px;text-align:center}
    #paused.show{display:grid}
    #loading{position:fixed;inset:0;display:grid;place-items:center;color:#0008;font-weight:700}
    @media (prefers-reduced-motion: reduce) {
      .spin { animation: none !important; }
    }
  </style>
</head>
<body>
  <div id="app">
    <canvas id="game" width="360" height="640" aria-label="Flappy Fly canvas" role="img"></canvas>
  </div>

  <div id="scoreText" aria-hidden="true">0</div>
  <div id="bigPopup" aria-hidden="true">+1</div>

  <div id="hud" aria-hidden="false">
    <label class="chip" title="Toggle high contrast">
      <input id="contrastToggle" type="checkbox" /> High contrast
    </label>
    <label class="chip" title="Mute sounds (saved)">
      <input id="muteToggle" type="checkbox" /> Mute
    </label>
    <span class="chip" id="hint">Tap / Click / Space to flap â€¢ P to pause</span>
  </div>

  <div id="paused" aria-hidden="true"><div>Paused â€” press <b>P</b> or tap to resume</div></div>

  <div id="overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div id="panel">
      <h2 id="panelTitle">Game Over</h2>
      <div class="row"><span>Score</span><b id="panelScore">0</b></div>
      <div class="row"><span>Best</span><b id="panelBest">0</b></div>
      <div class="row" id="panelBadge" style="display:none"><span>Medal</span><b id="badgeText">Bronze</b></div>
      <button id="playAgain">Play Again</button>
      <button id="shareBtn" style="margin-top:8px">Share</button>
    </div>
  </div>

  <div id="a11y" aria-live="polite" aria-atomic="true"></div>
  <div id="loading">Loadingâ€¦</div>

  <!-- ðŸŽµ Background Music -->
  <audio id="bgMusic" src="bgm.mp3" loop></audio>

  <script>
  // === Config ===
  const CFG = {
    canvas: { width:360, height:640 },
    physics: { gravity:1800, flapImpulse:-420, maxFallSpeed:900 },
    world: { speedStart:180, speedEnd:240, speedEndScore:30 },
    pipes: { gapStart:160, gapEnd:135, gapEndScore:20, spawnStart:1.20, spawnEnd:0.95, spawnEndScore:25, minGapCenterY:120, maxGapCenterYPaddingBottom:120 },
    bird: { size:{w:34,h:24}, hitboxRadius:12, idleBobPx:4 }
  };

  const DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const logicalW = CFG.canvas.width, logicalH = CFG.canvas.height;
  function resizeCanvas(){
    const vw = Math.min(window.innerWidth, 820);
    const vh = window.innerHeight;
    const scale = Math.min(vw/logicalW, vh/logicalH);
    const cssW = Math.floor(logicalW*scale), cssH = Math.floor(logicalH*scale);
    canvas.style.width = cssW+"px"; canvas.style.height = cssH+"px";
    canvas.width = Math.floor(logicalW * DPR); canvas.height = Math.floor(logicalH * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  addEventListener('resize', resizeCanvas);
  resizeCanvas();

  // === UI elements ===
  const $score = document.getElementById('scoreText');
  const $popup = document.getElementById('bigPopup');
  const $overlay = document.getElementById('overlay');
  const $panelScore = document.getElementById('panelScore');
  const $panelBest = document.getElementById('panelBest');
  const $panelBadge = document.getElementById('panelBadge');
  const $badgeText = document.getElementById('badgeText');
  const $playAgain = document.getElementById('playAgain');
  const $share = document.getElementById('shareBtn');
  const $a11y = document.getElementById('a11y');
  const $paused = document.getElementById('paused');
  const $loading = document.getElementById('loading');
  const $contrast = document.getElementById('contrastToggle');
  const $mute = document.getElementById('muteToggle');

  // === Storage ===
  const store = {
    get best(){ return +localStorage.getItem('bestScore')||0; },
    set best(v){ localStorage.setItem('bestScore', v); },
    get muted(){ return localStorage.getItem('muted')==='1'; },
    set muted(v){ localStorage.setItem('muted', v?'1':'0'); }
  };
  $mute.checked = store.muted;

  // === ðŸŽµ Background Music ===
  const bgMusic = document.getElementById('bgMusic');
  bgMusic.volume = 0.4;
  if (store.muted) bgMusic.muted = true;
  $mute.addEventListener('change', () => {
    store.muted = $mute.checked;
    bgMusic.muted = $mute.checked;
  });

  // === Audio Context & Beeps ===
  let AC = null; let userInteracted = false;
  function ensureAudio(){ if(AC || $mute.checked) return; AC = new (window.AudioContext||window.webkitAudioContext)(); }
  function beep(type='sine', f=440, t=0.08, gain=0.03){
    if($mute.checked || !AC) return;
    const o=AC.createOscillator(), g=AC.createGain();
    o.type=type; o.frequency.value=f; g.gain.value=gain;
    o.connect(g).connect(AC.destination); o.start(); o.stop(AC.currentTime + t);
  }
  const SFX = {
    flap(){ beep('square',700,0.06,0.05); },
    point(){ beep('triangle',900,0.07,0.045); },
    hit(){ beep('sawtooth',160,0.12,0.06); },
    die(){ beep('sine',100,0.25,0.04); },
    swoosh(){ beep('sine',500,0.15,0.03); }
  };

  // === Input ===
  function onPress(){
    userInteracted = true; ensureAudio();
    if(!store.muted && bgMusic.paused) bgMusic.play().catch(()=>{});
    if(game.state==='splash'){ startRunning(); SFX.swoosh(); }
    else if(game.state==='running'){ flap(); }
    if(game.paused){ togglePause(false); }
  }

  function flap(){
    if(!game.alive) return;
    game.bird.vy = CFG.physics.flapImpulse;
    game.bird.flapTick = game.time;
    SFX.flap();
  }

  // === Pause toggle with music ===
  function togglePause(force){
    if(game.state!=='running') return;
    const to = (typeof force==='boolean')? force : !game.paused;
    game.paused = to;
    $paused.classList.toggle('show', to);
    if (to) bgMusic.pause(); else if (!store.muted) bgMusic.play().catch(()=>{});
  }

  // === Game setup ===
  const game = {
    state:'splash', paused:false, alive:true, time:0, score:0, best:store.best,
    worldSpeed:CFG.world.speedStart, spawnTimer:0, spawnInterval:CFG.pipes.spawnStart,
    pipes:[], pipePool:[], bird:{x:72,y:320,vy:0,rot:0,frame:0,frameTimer:0,flapTick:-999}
  };

  function reset(){
    game.state='splash'; game.paused=false; game.alive=true;
    game.time=0; game.score=0;
    game.worldSpeed=CFG.world.speedStart;
    game.spawnTimer=0; game.spawnInterval=CFG.pipes.spawnStart;
    game.bird.x=72; game.bird.y=320; game.bird.vy=0;
    updateScore(0);
    bgMusic.currentTime = 0;
    if(!store.muted) bgMusic.play().catch(()=>{});
    hidePanel();
  }

  function endGame(){
    game.alive=false;
    SFX.die();
    bgMusic.pause();
    setTimeout(showPanel,600);
  }

  // === (rest of the code unchanged from your version) ===
  // === Run game ===
  function start(){ $loading.style.display='none'; updateScore(0); reset(); tick(); }
  start();
  </script>
</body>
</html>
